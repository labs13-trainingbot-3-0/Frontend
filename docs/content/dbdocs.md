# Database

## Table of Contents

- [Intro](#intro)
- [Overview](#overview)
  - [Diagram](#diagram)
  - [Resources](#resources)
    - [account_types](#account_types)
    - [users](#users)
    - [services](#services)
    - [tokens](#tokens)
    - [team_members](#team_members)
    - [training_series](#training_series)
    - [messages](#messages)
    - [notifications](#notifications)
    - [responses](#responses)
- [Database Standards](#database-standards)
  - [Methods](#methods)
  - [Key Names](#key-names)
- [Local Database](#local-database)

## Intro

This document will describe the data model built out for the back end, including links to an interactive diagram, describe the standard model methods and key names used to access and manipulate data within the database as well, and information for setting up a local database with PostgreSQL.

## Overview

The data model was refactored into this current shape based on the needs of the app--note that there are no many-to-many relationships. Previously, the back end had been duplicating data in Notifications from other tables such as Messages and Team Members that already existed in those tables. With this current model there is no duplication of data properties, and since the existence of a Notification linking a specific Message (and therefore Training Series) and Team Member together was the only confirmation needed that a Team Member was "assigned" to that Training Series, the many-to-many table connecting the Team Members and Training Series was eliminated. All needed database info is therefore accessible by simply joining as many tables together as required, and then selecting the desired information from wherever it may exist. This structure is simpler to work with on the back end with minimal filtering on the front end thanks to Redux, and is much more scalable if more data fields would be required.

### Diagram

[Link](https://dbdiagram.io/d/5cbdd308f7c5bb70c72fb643) to interactive diagram of current database model.

Special note about [dbdiagram.io]: you can generate a FK>>>PK relationship by simply dragging and dropping from the desired Foreign Key to the desired Primary Key.

![Diagram of database model](img/db-diagram.png)

### Resources

Note that all Tables are all snake_case and plural so as to allow for hassle-free manipulation with UNIX-based systems, database, query syntax, and reduction of typos. All tables also have auto-generated id integer as Primary Key. Seeded data is hard-code for some resources such as account_types which the current app calls for three specific entries and no more, other resources generated by [fakeData.js](https://github.com/labs12-training-bot-2/labs12-training-bot-2-BE/blob/master/helpers/fakeData.js) using npm package faker, see the documentation [here](https://github.com/marak/Faker.js/)

#### account_types

The types of accounts currently offered by the app: currently only free, premium, and pro, with an associated maximum notification count per month. User can change their account level via interaction with Stripe.

[Migrations](https://github.com/labs12-training-bot-2/labs12-training-bot-2-BE/blob/master/models/migrations/20190506173831_data_model_v2.js)

| property               | type    | description                                                                                        | required |
|------------------------|---------|----------------------------------------------------------------------------------------------------|----------|
| title                  | string  | Title of account type: currently only Free, Premium, and Pro based on user interaction with Stripe | yes      |
| max_notification_count | integer | Number of notifications a user is permitted per month based on type. Free:50, Premium:200, Pro:100 | yes      |



#### users

The logged-in end user that performs all operations within the app's front end. Other resources will be retrieved based on the currently logged-in user's email having been set on res.locals during authentication, and will not be able to retrieve information in the database they did not create.

[Migrations](https://github.com/labs12-training-bot-2/labs12-training-bot-2-BE/blob/master/models/migrations/20190506173831_data_model_v2.js#8-25) and [schema validation](https://github.com/labs12-training-bot-2/labs12-training-bot-2-BE/blob/master/models/schemas.js#3-20)

| property           | type         | description                                                                       | required |
|--------------------|--------------|-----------------------------------------------------------------------------------|----------|
| name               | string       | full user name                                                                    | yes      |
| email              | string       | user email, used for authentication                                               | yes      |
| stripe             | string       | Authenticated Stripe ID, if user has one                                          | no       |
| notifications_sent | integer      | Tracks how many notifications have been sent on user's behalf, resets every month | yes      |
| account_type_id    | integer (FK) | points to account_types.id                                                        | yes      |


#### services

Services available for messaging option, currently Twilio, Sendgrid, and Slack.

[Migrations](https://github.com/labs12-training-bot-2/labs12-training-bot-2-BE/blob/master/models/migrations/20190506173831_data_model_v2.js#26-29)

| property | type   | description                                                                                             | required |
|----------|--------|---------------------------------------------------------------------------------------------------------|----------|
| name     | string | name of services available for messaging Team Members, currently limited to twilio, sendgrid, and slack | yes      |


#### tokens

Tokens stored either for oAuth authentication or Slack identity validation. Stored for a specific User.

[Migrations](https://github.com/labs12-training-bot-2/labs12-training-bot-2-BE/blob/master/models/migrations/20190506173831_data_model_v2.js#30-49) and [schema validation](https://github.com/labs12-training-bot-2/labs12-training-bot-2-BE/blob/master/models/schemas.js#75-89)


| property      | type         | description                                                               | required |
|---------------|--------------|---------------------------------------------------------------------------|----------|
| expiration    | datetime     | when stored token will no longer be valid                                 | no       |
| auth_token    | string       | token given for oAuth authentication                                      | yes      |
| refresh_token | string       | provided by oAuth services if needed for obtaining a renewed access token | no       |
| service_id    | integer (FK) | points to services.id                                                     | yes      |
| user_id       | integer (FK) | points to users.id                                                        | yes      |


#### team_members

Team Members that will be sent automated messages containing the training content. Can have other Team Members assigned as their manager or mentor, which allows for other options for who gets sent messages when the Team Member is assigned to a Training Series.

[Migrations](https://github.com/labs12-training-bot-2/labs12-training-bot-2-BE/blob/master/models/migrations/20190506173831_data_model_v2.js#50-77) and [schema validation](https://github.com/labs12-training-bot-2/labs12-training-bot-2-BE/blob/master/models/schemas.js#22-45)

| property        | type         | description                                                                                                                    | required |
|-----------------|--------------|--------------------------------------------------------------------------------------------------------------------------------|----------|
| first_name      | string       | team member's first name                                                                                                       | yes      |
| last_name       | string       | team member's last name                                                                                                        | yes      |
| job_description | string       | team member's job description                                                                                                  | no       |
| email           | string       | team member's email, used for sending sendgrid messages if present                                                             | no       |
| phone_number    | string       | team member's phone number, used for sending twilio messages and is required so a team member has at least one form of contact | yes      |
| slack_uuid      | string       | unique identifier for team member's slack account, used to send slack messages if integrated and present                       | no       |
| manager_id      | integer (FK) | points to other entry in team_members table, denotes manager relationship with team member                                     | no       |
| mentor_id       | integer (FK) | points to other entry in team_members table, denotes mentor relationship team member                                           | no       |


#### training_series

Describes the Training Series that any number of Messages with training content can be generated for--any Team Member assigned to a given series (or their manager or mentor) can be sent these messages. The act of assigning a Team Member to the series, including options as to which available messaging medium the communication should go through, is what generates the actual Notifications that are delivered to said Team Member.

[Migrations](https://github.com/labs12-training-bot-2/labs12-training-bot-2-BE/blob/master/models/migrations/20190506173831_data_model_v2.js#78-88) and [schema validation](https://github.com/labs12-training-bot-2/labs12-training-bot-2-BE/blob/master/models/schemas.js#47-53)

| property | type         | description              | required |
|----------|--------------|--------------------------|----------|
| title    | string       | title of training series | yes      |
| user_id  | integer (FK) | points to users.id       | yes      |


#### messages

User creates this content with a title and description of what the message is, optionally includes a URL link for content. Note that said link is not meant to be generated by the app, this would be the actual training content that end users would want their employees to receive messages about so they could complete training.

[Primary migration](https://github.com/labs12-training-bot-2/labs12-training-bot-2-BE/blob/master/models/migrations/20190506173831_data_model_v2.js#89-110), [secondary migration](https://github.com/labs12-training-bot-2/labs12-training-bot-2-BE/blob/master/models/migrations/20190515004244_add_for_team_member.js#3-7) and [schema validation](https://github.com/labs12-training-bot-2/labs12-training-bot-2-BE/blob/master/models/schemas.js#55-73)

| property           | type         | description                                                                                                                                                   | required |
|--------------------|--------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| subject            | string       | subject of message to be sent to team members assigned to training series                                                                                     | yes      |
| body               | string       | message content                                                                                                                                               | yes      |
| link               | string       | url string that links message recipient to training content (not created by app)                                                                              | no       |
| training_series_id | integer (FK) | points to Training Series the message was created for                                                                                                         | yes      |
| for_manager        | boolean      | denotes whether message will send notification to an assigned Team Member's manager, defaults to false                                                        | no       |
| for_mentor         | boolean      | denotes whether message will send notification to an assigned Team Member's mentor, defaults to false                                                         | no       |
| for_manager        | boolean      | denotes whether message will send notification to an assigned Team Member's manager, defaults to false                                                        | no       |
| for_team_member    | boolean      | denotes whether message will send notification to an assigned Team Member, defaults to false. if not set to true, assume it must be sent to manager or mentor | no       |
| days_from_start    | int          | how many days from the start of a Team Member being assigned to the Training Series before the Message will be sent                                           | yes      |


#### notifications

Notifications are automatically generated when a Team Member is assigned to a Training Series that has Messages. Note that the team_member_id is the ID of the Team Member who was originally assigned, but since we want to allow messaging of managers and mentors only for a Message that the Team Member themselves would not receive, or to send a Message to any combination of all three, the recipient_id denotes the Team Member this Notification is actually going to and may be different than team_member_id.

[Primary migration](https://github.com/labs12-training-bot-2/labs12-training-bot-2-BE/blob/master/models/migrations/20190506173831_data_model_v2.js#111-144), [secondary migration](https://github.com/labs12-training-bot-2/labs12-training-bot-2-BE/blob/master/models/migrations/20190521131026_add_recipient_id.js#3-10) and [schema validation](https://github.com/labs12-training-bot-2/labs12-training-bot-2-BE/blob/master/models/schemas.js#91-115)

| property       | type        | description                                                                                                                                              | required |
|----------------|-------------|----------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| send_date      | datetime    | calculated datetime for when notification will be sent based on when recipient is set to start the Training Series based on messages.days_from_start     | yes      |
| is_sent        | boolean     | denotes whether Notification has been successfully sent, defaults to false                                                                               | yes      |
| num_attempts   | integer     | how many times Notification has attempted to be sent--current max allowed is 6                                                                           | yes      |
| thread         | string      | unique thread relating to message history between recipient Team Member and Slack                                                                        | no       |
| message_id     | integer(FK) | points to message.id of Message this Notification was generated from                                                                                     | yes      |
| service_id     | integer(FK) | points to services.id to denote whether messaging medium is twilio, sendgrid, or slack (currently no others)                                             | yes      |
| team_member_id | integer(FK) | points to team_members.id of Team Member whose assignment to the Training Series caused the Notification to be generated (not necessarily the recipient) | yes      |
| recipient_id   | integer(FK) | points to team_members.id of Team Member the Notification is going to--may be assigned Team Member's manager or mentor                                   | yes      |


#### responses

The catalogued Response from a Team Member as a reply to the Notification they received from the specific service. This currently could be either an sms response from Twilio, an email response from Sendgrid, or a DM chat response from Slack.

[Migrations](https://github.com/labs12-training-bot-2/labs12-training-bot-2-BE/blob/master/models/migrations/20190506173831_data_model_v2.js#145-159) and [schema validation](https://github.com/labs12-training-bot-2/labs12-training-bot-2-BE/blob/master/models/schemas.js#117-124)

| property        | type        | description                                                                                   | required |
|-----------------|-------------|-----------------------------------------------------------------------------------------------|----------|
| body            | string      | contents of response from Team Member to a successfully sent Notification, needs to be parsed | no       |
| notification_id | integer(FK) | points to notifications.id of Notification the Response is responding to                      | yes      |
| created_at      | timestamp   | timestamp of when Response was created, used to filter based on most recent                   | yes      |


## Database Standards

These sections describe the standards adhered when accessing the back end in the interest of making the code scalable, easy to work with once you know the codebase, integrate extra table resources, write extra endpoints to access those resources, or to audit any of the existing methods and endpoints.

### Methods

Originally almost all of the existing resources had anywhere between 5 and 10 database methods, many of which were superfluous. All resources now have 4 standardized methods to minimize confusion and simplify both bug-hunting and expansion of functionality. The few exceptions here are that Responses do not require an .update() method in the current scope of the app, Tokens.add() first perform a nested Services.find() to retrieve the desired services.id, Users.find() selects different fields depending on whether it was passed a filter or not, and Notifications.update() does not return the updated resource as it is not currently required.

| method                   | description                                                                                                                                                                                                  |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| .find(filters)           | Can READ either a single resource or multiple resources based on the filter passed in. It is the controller's responsibility to chain .first() on the response if expecting retrieve only a single resource. |
| .add(resource)           | CREATES resource into the database, then performs chained .find()  to retrieve the newly-created object by its ID with the shape we laid out instead of just the values existing for that resource.          |
| .update(filter, changes) | UPDATES specific resource in the database based on the filters passed in (usually its own ID) and the sent changes, then performs chained .find() to retrieve the updated resource.                          |
| .remove(filter)          | DELETES resource from the database based on filter (usually its own ID, but other fields are used). Returns default 0 or 1 if deletion failed or succeeded.                                                  |


### Key Names

Methods use a standardized abbreviations for methods that require filtering or joining onto other resource tables (resource AS abbreviation)

| resource        | abbreviation |
|-----------------|--------------|
| messages        | m            |
| users           | u            |
| training_series | ts           |
| team_members    | tm           |
| responses       | r            |
| tokens          | tk           |
| services        | s            |
| account_types   | a            |


 See documentation for [Knex.js](https://knexjs.org/#Builder-join) for further information on joins and the syntax used.

## Local Database

Local database setup will require installation of postgreSQL as a service on your local machine, and not just run in your IDE as a library. Different installation methods exist depending on your OS, check out the documentation on installing at [postgresql.org](https://www.postgresql.org/download/)